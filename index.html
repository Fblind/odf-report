<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Odf-report by sandrods</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35945147-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Odf-report</h1>
        <p>Generates ODF files, given a template (.odt) and data, replacing tags</p>
        <p class="view"><a href="https://github.com/sandrods/odf-report">View the Project on GitHub <small>sandrods/odf-report</small></a></p>
        <ul>
          <li><a href="https://github.com/sandrods/odf-report/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/sandrods/odf-report/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/sandrods/odf-report">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>


<h2>INSTALL</h2>

<pre><code>(sudo) gem install odf-report
</code></pre>

<h2>USAGE</h2>

<h3>Step 1  --  the template</h3>

<p>First of all, you need to create a .odt file to serve as a template</p>

<p>Templates are normal .odt files with placeholders for Substitutions</p>

<p>There are now <em>four</em> kinds of substitutions available: </p>

<ul>
<li>fields</li>
<li>tables</li>
<li>images</li>
<li>sections</li>
</ul><h3>Fields placeholders</h3>

<p>It's just an upcase sentence, surrounded by brackets. It will be replaced for wathever value you supply.</p>

<p>In the folowing example:</p>

<div class="highlight"><pre><span class="n">report</span> <span class="o">=</span> <span class="no">ODFReport</span><span class="o">::</span><span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Users/john/my_template.odt"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>

  <span class="n">r</span><span class="o">.</span><span class="n">add_field</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
  <span class="n">r</span><span class="o">.</span><span class="n">add_field</span> <span class="ss">:address</span><span class="p">,</span> <span class="s2">"My new address"</span>

<span class="k">end</span>
</pre></div>

<p>All occurences of <strong>[USER_NAME]</strong> found in the file will be replaced by the value of <strong>@user.name</strong> whereas all <strong>[ADDRESS]</strong> 'es will contains <strong>My new address</strong></p>

<p>It's as simple as that.</p>

<h3>Table placeholders</h3>

<p>To use table placeholders, you should create a Table in your document and give it a name. In OpenOffice, it's just a matter of right-clicking the table you just created, choose <em>Table...</em> and type a name in the Name field.</p>

<img src="images/table_name.png" />

<p>If you inform <strong>:header=&gt;true</strong>, the first row will be treated as a <em>header</em> and left untouched. The remaining rows will be used as the template for the table. If you have more than one template row, they will be cycled. This is usefull for making zebra tables.</p>

<p>As with Field placeholders, just insert a <strong>[FIELD_NAME]</strong> in each cell and let the magic takes place.</p>

<p>Taking the folowing example:</p>

<div class="highlight"><pre><span class="n">report</span> <span class="o">=</span> <span class="no">ODFReport</span><span class="o">::</span><span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Users/john/my_template.odt"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>

  <span class="n">r</span><span class="o">.</span><span class="n">add_field</span> <span class="s2">"USER_NAME"</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nome</span>
  <span class="n">r</span><span class="o">.</span><span class="n">add_field</span> <span class="s2">"ADDRESS"</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">address</span>

  <span class="n">r</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="s2">"TABLE_1"</span><span class="p">,</span> <span class="vi">@list_of_itens</span><span class="p">,</span> <span class="ss">:header</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:item_id</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:description</span><span class="p">)</span> <span class="k">do</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="s2">"==&gt; </span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>and considering you have a table like this in your template</p>

<img src="images/table1.png" />

<p>and a collection <strong>@list_of_itens</strong>, it will be created one row for each item in the collection, and the replacement will take place accordingly.</p>

<p>Any format applied to the fields in the template will be preserved.</p>

<h3>Images</h3>

<p>You must put a mock image in your odt template and give it a name. That name will be used to replace the mock image for the actual image.
You can also assign any properties you want to the mock image and they will be kept once the image is replaced.</p>

<p>An image replace would look like this:</p>

<div class="highlight"><pre><span class="n">report</span> <span class="o">=</span> <span class="no">ODFReport</span><span class="o">::</span><span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Users/john/my_template.odt"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>

  <span class="n">r</span><span class="o">.</span><span class="n">add_image</span> <span class="ss">:graphics1</span><span class="p">,</span> <span class="s2">"/path/to/the/image.jpg"</span>

<span class="k">end</span>
</pre></div>

<h3>Sections</h3>

<p>Sometimes, you have to repeat a whole chunk of a document, in a structure a lot more complex than a table. In this cases, you can use a Section in your template. Creating a Section in OpenOffice is as easy as select menu <em>Insert</em> and then <em>Section...</em>, and then choose a name for it.</p>

<p><em>Section</em> 's are lot like Tables, in the sense that you can pass a collection and have that section repeated for each member of the collection. <em>But</em>, Sections can have anything inside it, even Tables <em>and nested Sections</em>, as long as you pass the appropriate data structure.</p>

<p>Let's see an example:</p>

<div class="highlight"><pre>  <span class="vi">@invoices</span> <span class="o">=</span> <span class="no">Invoice</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>

  <span class="n">report</span> <span class="o">=</span> <span class="no">ODFReport</span><span class="o">::</span><span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"reports/invoice.odt"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>

    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"INVOICES REPORT"</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:date</span><span class="p">,</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>

    <span class="n">r</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">"SC_INVOICE"</span><span class="p">,</span> <span class="vi">@invoices</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>

      <span class="n">s</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:number</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span> <span class="n">invoice</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">s</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span>    <span class="ss">:customer_name</span><span class="p">)</span>
      <span class="n">s</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:address</span><span class="p">,</span> <span class="ss">:customer_address</span><span class="p">)</span>

      <span class="n">s</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="s2">"TB_ITEMS"</span><span class="p">,</span> <span class="ss">:items</span><span class="p">,</span> <span class="ss">:header</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:product</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span> <span class="p">}</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:value</span><span class="p">,</span> <span class="ss">:product_value</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">s</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:total</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">'CLOSED'</span>
          <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
        <span class="k">else</span>
          <span class="n">invoice</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">'product_value'</span><span class="p">)}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">s</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">"SUB_NOTES"</span><span class="p">,</span> <span class="ss">:notes</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">s1</span><span class="o">|</span>

        <span class="n">s1</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:note_title</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span><span class="o">.</span><span class="n">title</span> <span class="p">}</span>

        <span class="n">s1</span><span class="o">.</span><span class="n">add_table</span> <span class="o">(...)</span>

      <span class="k">end</span>

    <span class="k">end</span>

  <span class="k">end</span>
</pre></div>

<p>Note that when you add a Table to a Section, you don't pass the collection itself, but the attribute of the item of that section that's going to return the collection for that particular Table. Sounds complicated, huh? But once you get it, it's quite straightforward.</p>

<p>In the above example, <pre><code>s.add_table("TB_ITEMS", :items, :header =&gt; true) do |t|</code></pre>, the <strong><code>:items</code></strong> thing refers to a <strong><code>invoice.items</code></strong>. Easy, right?</p>

<hr>

<h3>Step 2  --  generating the document</h3>

<p>It's fairly simple to generate the document. You can use this inside a Rails application or in a standalone script.</p>

<h4>Generating a document in a Rails application</h4>

<p>In a controller, you can have a code like this:</p>

<div class="highlight"><pre><span class="k">def</span> <span class="nf">print</span>

  <span class="vi">@ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>

  <span class="n">report</span> <span class="o">=</span> <span class="no">ODFReport</span><span class="o">::</span><span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">RAILS_ROOT</span><span class="si">}</span><span class="s2">/app/reports/ticket.odt"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>

    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span>         <span class="vi">@ticket</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:created_by</span><span class="p">,</span> <span class="vi">@ticket</span><span class="o">.</span><span class="n">created_by</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">,</span> <span class="vi">@ticket</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%d/%m/%Y - %H:%M"</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:type</span><span class="p">,</span>       <span class="vi">@ticket</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:status</span><span class="p">,</span>     <span class="vi">@ticket</span><span class="o">.</span><span class="n">status_text</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:date</span><span class="p">,</span>       <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%d/%m/%Y - %H:%M"</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="ss">:solution</span><span class="p">,</span>   <span class="p">(</span><span class="vi">@ticket</span><span class="o">.</span><span class="n">solution</span> <span class="o">||</span> <span class="s1">''</span><span class="p">))</span>

    <span class="n">r</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="s2">"OPERATORS"</span><span class="p">,</span> <span class="vi">@ticket</span><span class="o">.</span><span class="n">operators</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:operator_name</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="o">|</span> <span class="s2">"</span><span class="si">#{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">#{</span><span class="n">op</span><span class="o">.</span><span class="n">department</span><span class="o">.</span><span class="n">short_name</span><span class="si">}</span><span class="s2">)"</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">r</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="s2">"FIELDS"</span><span class="p">,</span> <span class="vi">@ticket</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:field_name</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
      <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="ss">:field_value</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span> <span class="n">field</span><span class="o">.</span><span class="n">text_value</span> <span class="o">||</span> <span class="s2">"Empty"</span> <span class="p">}</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">report_file_name</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">generate</span>

  <span class="n">send_file</span><span class="p">(</span><span class="n">report_file_name</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>

<p>The <strong>generate</strong> method will, well, generate the document in a temp dir and returns the full path of the generated file, so you can send it back to the user.</p>

<h4>Generating a document in a standalone script</h4>

<p>It's just the same as in a Rails app, but you can inform the path where the file will be generated instead of using a temp dir.</p>

<div class="highlight"><pre><span class="n">report</span> <span class="o">=</span> <span class="no">ODFReport</span><span class="o">::</span><span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"ticket.odt"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="n">populates</span> <span class="n">the</span> <span class="n">report</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>

<span class="k">end</span>

<span class="n">report</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s2">"./documents/"</span><span class="p">)</span>
</pre></div>

<hr><h3>REQUIREMENTS</h3>

<p><strong>rubyzip</strong>: for manipulating the contents of the odt file, since it's actually a zip file.</p>

<p><strong>nokogiri</strong>: for parsing and manipulating the document xml files.</p>

<a href="https://codeclimate.com/github/sandrods/odf-report"><img src="https://codeclimate.com/github/sandrods/odf-report.png" /></a>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/sandrods">sandrods</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

  </body>
</html>
